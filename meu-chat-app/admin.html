<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - RandomSocial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { min-height: 100vh; background-color: #343a40; color: white; padding-top: 20px; }
        .sidebar a { color: #cfd2d6; text-decoration: none; display: block; padding: 10px 20px; }
        .sidebar a:hover, .sidebar a.active { background-color: #007bff; color: white; }
        .card { margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .log-box { max-height: 300px; overflow-y: auto; background: #eee; padding: 10px; border-radius: 5px; }
        /* MUDAN√áA: Cores para diferenciar Denunciante/Acusado no log */
        .msg-eu { text-align: right; color: #007bff; } /* Azul - Denunciante */
        .msg-eles { text-align: left; color: #28a745; } /* Verde - Acusado */
        .status-on { color: green; font-weight: bold; }
        .status-off { color: gray; }
        .foto-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
    </style>
</head>
<body>

<div id="login-screen" class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card p-5 text-center">
        <h3>üîí √Årea Restrita</h3>
        <p>Painel de Controle do App</p>
        <input type="password" id="admin-password" class="form-control mb-3" placeholder="Senha de Administrador" onkeyup="if(event.key === 'Enter') conectarAdmin()">
        <button onclick="conectarAdmin()" class="btn btn-primary w-100">CONECTAR COMO ADMIN</button>
        <p id="status-conn" class="mt-3 text-muted">Aguardando...</p>
    </div>
</div>

<div id="dashboard" class="container-fluid d-none">
    <div class="row">
        <div class="col-md-2 sidebar">
            <h4 class="text-center mb-4">üõ°Ô∏è ADMIN</h4>
            <a href="#" onclick="mudarAba('usuarios')" id="link-usuarios" class="active">üë• Usu√°rios</a>
            <a href="#" onclick="mudarAba('denuncias')" id="link-denuncias">üö® Den√∫ncias <span id="badge-denuncia" class="badge bg-danger float-end d-none">0</span></a>
            <a href="#" onclick="mudarAba('broadcast')" id="link-broadcast">üì¢ Mensagem Global</a>
        </div>

        <div class="col-md-10 p-4">
            
            <div id="tab-usuarios">
                <h2>Gerenciar Usu√°rios</h2>
                <div class="input-group mb-3">
                    <input type="text" id="busca-user" class="form-control" placeholder="Buscar por @nick..." onkeyup="filtrarUsuarios()">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover bg-white rounded">
                        <thead class="table-dark">
                            <tr>
                                <th>Foto</th>
                                <th>Nick</th>
                                <th>Nome</th>
                                <th>Idade/G√™nero</th>
                                <th>Status</th>
                                <th>Selos</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-users">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-denuncias" class="d-none">
                <h2>Den√∫ncias Pendentes</h2>
                <div id="lista-reports"></div>
            </div>

            <div id="tab-broadcast" class="d-none">
                <div class="card p-4">
                    <h3>Enviar Alerta Global</h3>
                    <p>Isso aparecer√° no topo da tela de TODOS os usu√°rios online.</p>
                    <textarea id="txt-broadcast" class="form-control mb-3" rows="4" placeholder="Ex: Manuten√ß√£o em 15 minutos..."></textarea>
                    <button onclick="enviarBroadcast()" class="btn btn-warning fw-bold">ENVIAR ALERTA üì¢</button>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalLog" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prova da Den√∫ncia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="log-chat-content" class="log-box"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const SOCKET_URL = 'http://localhost:3000'; // SEU IP OU LOCALHOST
    let socket;
    let allUsers = [];
    let allReports = [];

    function conectarAdmin() {
        const password = document.getElementById('admin-password').value; // <-- Pega a senha
        if (!password) {
            document.getElementById('status-conn').innerText = 'Por favor, digite a senha.';
            return;
        }

        document.getElementById('status-conn').innerText = 'Conectando ao servidor...';
        socket = io(SOCKET_URL);

        socket.on('connect', () => {
            console.log('Conectado!');
            // MUDAN√áA: Envia o nick e a senha para autentica√ß√£o
            socket.emit('login', { nick: 'admin', password: password });
        });

        socket.on('login_sucesso', (dados) => {
            if(dados.isAdmin) {
                document.getElementById('login-screen').classList.add('d-none');
                document.getElementById('dashboard').classList.remove('d-none');
                carregarDados();
            } else {
                alert('Este login n√£o √© admin!');
            }
        });

        socket.on('admin_dados_recebidos', (dados) => {
            allUsers = dados.usuarios;
            allReports = dados.denuncias;
            renderUsuarios(allUsers);
            renderDenuncias(allReports);
        });

        socket.on('admin_confirmacao', () => {
            // Recarrega dados ap√≥s uma a√ß√£o
            carregarDados();
        });
    }

    function carregarDados() {
        socket.emit('admin_obter_dados');
    }

    // --- RENDERIZADORES ---

    function renderUsuarios(lista) {
        const tbody = document.getElementById('lista-users');
        tbody.innerHTML = '';
        lista.forEach(u => {
            const foto = u.fotoPrincipal || 'https://via.placeholder.com/40';
            const row = `
                <tr>
                    <td><img src="${foto}" class="foto-thumb"></td>
                    <td class="fw-bold">@${u.nick}</td>
                    <td>${u.nome}</td>
                    <td>${u.idade} / ${u.genero}</td>
                    <td>
                        ${u.banido ? '<span class="badge bg-danger">BANIDO</span>' : '<span class="badge bg-success">ATIVO</span>'}
                        ${u.online ? '<span class="status-on">‚óè</span>' : '<span class="status-off">‚óã</span>'}
                    </td>
                    <td>
                        ${u.verificado ? '‚úÖ' : ''} ${u.premium ? '‚≠ê' : ''}
                    </td>
                    <td>
                        <button onclick="acaoUser('${u.nick}', 'banir', ${!u.banido})" class="btn btn-sm ${u.banido?'btn-success':'btn-danger'}">
                            ${u.banido ? 'Desbanir' : 'Banir'}
                        </button>
                        <button onclick="acaoUser('${u.nick}', 'limpar_foto', true)" class="btn btn-sm btn-secondary">Del. Foto</button>
                        <button onclick="enviarAvisoPrivado('${u.nick}')" class="btn btn-sm btn-info">Avisar</button>
                        <div class="btn-group mt-1">
                            <button onclick="acaoUser('${u.nick}', 'verificado', ${!u.verificado})" class="btn btn-sm btn-outline-primary">Verif</button>
                            <button onclick="acaoUser('${u.nick}', 'premium', ${!u.premium})" class="btn btn-sm btn-outline-warning">Prem</button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function renderDenuncias(lista) {
        const div = document.getElementById('lista-reports');
        div.innerHTML = '';
        
        const badge = document.getElementById('badge-denuncia');
        if(lista.length > 0) {
            badge.innerText = lista.length;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
            div.innerHTML = '<p class="text-muted">Nenhuma den√∫ncia pendente.</p>';
            return;
        }

        lista.forEach(d => {
            const card = `
                <div class="card p-3 border-danger">
                    <div class="d-flex justify-content-between">
                        <h5 class="text-danger">Motivo: ${d.motivo}</h5>
                        <small>${new Date(d.data).toLocaleString()}</small>
                    </div>
                    <p><strong>Denunciante:</strong> @${d.denunciante} <br> <strong>Acusado:</strong> @${d.denunciado}</p>
                    <div class="d-flex gap-2">
                        <button onclick='verLog(${JSON.stringify(d.logs)}, "${d.denunciante}", "${d.denunciado}")' class="btn btn-primary btn-sm">üëÅÔ∏è Ver Prova (Chat)</button>
                        <button onclick="resolverDenuncia('${d.id}')" class="btn btn-success btn-sm">‚úÖ Marcar Resolvido</button>
                        <button onclick="acaoUser('${d.denunciado}', 'banir', true)" class="btn btn-danger btn-sm">üî® Banir Acusado</button>
                    </div>
                </div>
            `;
            div.innerHTML += card;
        });
    }

    // --- A√á√ïES ---

    function acaoUser(nick, acao, valor) {
        if(confirm(`Tem certeza que deseja aplicar ${acao} em @${nick}?`)) {
            socket.emit('admin_acao', { alvoNick: nick, acao, valor });
        }
    }

    function resolverDenuncia(id) {
        socket.emit('admin_resolver_report', id);
    }

    function enviarBroadcast() {
        const txt = document.getElementById('txt-broadcast').value;
        if(txt) {
            socket.emit('admin_broadcast', txt);
            alert('Enviado!');
            document.getElementById('txt-broadcast').value = '';
        }
    }

    // NOVO: Fun√ß√£o para enviar Aviso Privado
    function enviarAvisoPrivado(nick) {
        const mensagem = prompt(`Enviar aviso privado para @${nick}:\n(Ex: A pr√≥xima foto fora das regras resultar√° em banimento)`);
        if(mensagem) {
            // O servidor adiciona o prefixo "‚ö†Ô∏è Aviso da Administra√ß√£o: "
            socket.emit('admin_enviar_aviso_privado', { alvoNick: nick, mensagem: mensagem });
            alert(`Aviso enviado para @${nick}.`);
        }
    }

    // MUDAN√áA: Fun√ß√£o verLog aprimorada com identifica√ß√£o de remetente (Denunciante vs Acusado)
    function verLog(logs, denuncianteNick, acusadoNick) {
        const content = document.getElementById('log-chat-content');
        content.innerHTML = '';
        if(!logs || logs.length === 0) {
            content.innerHTML = '<p>Sem hist√≥rico dispon√≠vel (o cliente n√£o enviou mensagens suficientes antes de reportar).</p>';
        } else {
            logs.forEach(l => {
                // A l√≥gica do cliente salva quem envia como 'eu'. Assumimos que 'eu' √© o denunciante.
                const remetente = l.sender === 'eu' ? denuncianteNick : acusadoNick; 
                const papel = l.sender === 'eu' ? 'DENUNCIANTE' : 'ACUSADO';
                const estilo = l.sender === 'eu' ? 'msg-eu' : 'msg-eles';

                const tipoConteudo = l.type === 'image' ? `[FOTO ENVIADA: Origem ${l.origin}]` : l.content;
                
                const div = document.createElement('div');
                div.className = estilo;
                div.style.borderBottom = '1px solid #ccc';
                div.style.padding = '5px';
                
                div.innerHTML = `
                    <strong>@${remetente} (${papel}):</strong> 
                    ${tipoConteudo}
                    <small class="text-muted">${new Date(parseInt(l.id)).toLocaleTimeString()}</small>
                `;
                content.appendChild(div);
            });
        }
        new bootstrap.Modal(document.getElementById('modalLog')).show();
    }

    // --- UI UX ---
    function mudarAba(aba) {
        document.getElementById('tab-usuarios').classList.add('d-none');
        document.getElementById('tab-denuncias').classList.add('d-none');
        document.getElementById('tab-broadcast').classList.add('d-none');
        document.getElementById('link-usuarios').classList.remove('active');
        document.getElementById('link-denuncias').classList.remove('active');
        document.getElementById('link-broadcast').classList.remove('active');

        document.getElementById('tab-' + aba).classList.remove('d-none');
        document.getElementById('link-' + aba).classList.add('active');
    }

    function filtrarUsuarios() {
        const termo = document.getElementById('busca-user').value.toLowerCase();
        const filtrados = allUsers.filter(u => u.nick.toLowerCase().includes(termo));
        renderUsuarios(filtrados);
    }
</script>

</body>
</html>